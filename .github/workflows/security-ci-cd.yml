name: ğŸ”’ LibraryOfBabel Security CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Security scan every day at 2 AM
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  SECURITY_SCAN_ENABLED: true

jobs:
  # ğŸ” Security Pre-Check (Fastest - Fails Fast)
  security-precheck:
    name: ğŸ”’ Security Pre-Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for security analysis
    
    - name: ğŸš¨ Secret Detection
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
    
    - name: ğŸ”’ API Key Leak Detection
      run: |
        echo "ğŸ” Scanning for API key patterns..."
        if grep -r "babel_secure_[0-9a-f]" --include="*.py" --include="*.js" --include="*.md" --include="*.json" .; then
          echo "ğŸš¨ ERROR: API key pattern found in code!"
          exit 1
        fi
        echo "âœ… No API key leaks detected"
    
    - name: ğŸ›¡ï¸ Environment File Check
      run: |
        echo "ğŸ” Checking for committed environment files..."
        if find . -name ".env*" -not -path "./node_modules/*" -not -name ".env.example"; then
          echo "ğŸš¨ ERROR: Environment files found in repository!"
          exit 1
        fi
        echo "âœ… No environment files committed"

  # ğŸ§ª Code Quality & Testing
  code-quality:
    name: ğŸ§ª Code Quality & Testing
    runs-on: ubuntu-latest
    needs: security-precheck
    timeout-minutes: 20
    
    strategy:
      matrix:
        component: [backend, frontend, agents]
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety pytest pytest-cov
    
    - name: ğŸ”’ Python Security Scan (Bandit)
      run: |
        echo "ğŸ” Running Python security analysis..."
        bandit -r . -f json -o security-report.json || true
        bandit -r . -ll
    
    - name: ğŸ›¡ï¸ Dependency Vulnerability Check
      run: |
        echo "ğŸ” Checking for vulnerable dependencies..."
        safety check --json --output safety-report.json || true
        safety check
    
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running test suite..."
        pytest tests/ -v --cov=src/ --cov-report=xml --cov-report=term
    
    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: ${{ matrix.component }}
        name: codecov-${{ matrix.component }}

  # ğŸ” Advanced Security Analysis
  security-analysis:
    name: ğŸ” Advanced Security Analysis
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 15
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”’ CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: python, javascript
    
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
    
    - name: ğŸ›¡ï¸ Container Security Scan
      if: contains(github.event.head_commit.message, 'docker')
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ğŸ” API Security Testing
      run: |
        echo "ğŸ” Testing API security..."
        python scripts/key_rotation_monitor.py
        python config/api_key_rotation.py --status

  # ğŸš€ Deployment Security
  deployment-security:
    name: ğŸš€ Deployment Security
    runs-on: ubuntu-latest
    needs: [security-precheck, code-quality, security-analysis]
    if: github.ref == 'refs/heads/main'
    environment: production
    timeout-minutes: 30
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”’ Verify Deployment Security
      run: |
        echo "ğŸ” Pre-deployment security verification..."
        # Check that API keys are properly configured
        if [ -f "config/api_key_rotation.py" ]; then
          echo "âœ… API rotation system present"
        else
          echo "ğŸš¨ ERROR: API rotation system missing!"
          exit 1
        fi
    
    - name: ğŸ›¡ï¸ Environment Security Check
      run: |
        echo "ğŸ” Checking environment security..."
        # Verify no secrets in environment
        env | grep -v "GITHUB_" | grep -v "RUNNER_" | grep -v "_URL" | grep -v "_PATH" || true
    
    - name: ğŸ“Š Generate Security Report
      run: |
        echo "ğŸ“Š Generating security report..."
        cat > security-deployment-report.md << 'EOF'
        # ğŸ”’ Security Deployment Report
        
        ## âœ… Security Checks Passed:
        - Secret detection: PASSED
        - API key leak detection: PASSED
        - Dependency vulnerabilities: PASSED
        - Code quality: PASSED
        - Advanced security analysis: PASSED
        
        ## ğŸ›¡ï¸ Security Features Active:
        - 30-day API key rotation system
        - Comprehensive monitoring
        - Automated security scanning
        - Environment protection
        
        ## ğŸ“… Report Generated: $(date)
        EOF
    
    - name: ğŸš€ Deploy (Placeholder)
      run: |
        echo "ğŸš€ Deployment would happen here..."
        echo "âœ… Security verification complete"

  # ğŸ“Š Security Monitoring
  security-monitoring:
    name: ğŸ“Š Security Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 10
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”’ Daily Security Scan
      run: |
        echo "ğŸ” Running daily security monitoring..."
        python scripts/key_rotation_monitor.py
        
    - name: ğŸ›¡ï¸ API Key Rotation Check
      run: |
        echo "ğŸ” Checking API key rotation status..."
        python config/api_key_rotation.py --status
    
    - name: ğŸ“Š Security Health Report
      run: |
        echo "ğŸ“Š Generating security health report..."
        echo "Security monitoring completed at $(date)" > security-health.log

  # ğŸ¤– Agent Integration Testing
  agent-integration:
    name: ğŸ¤– Agent Integration Testing
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 25
    
    steps:
    - name: ğŸ” Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ¤– Test Agent Systems
      run: |
        echo "ğŸ¤– Testing agent integration..."
        python -m pytest tests/test_reddit_agent.py -v
        python -m pytest tests/test_integration.py -v
    
    - name: ğŸ“Š Agent Performance Testing
      run: |
        echo "ğŸ“Š Testing agent performance..."
        python -m pytest tests/test_performance.py -v
    
    - name: ğŸ”’ Agent Security Testing
      run: |
        echo "ğŸ”’ Testing agent security..."
        python agents/security_qa/security_qa_agent.py || true

# ğŸ¯ Workflow Summary:
# 1. Security Pre-Check (Fast fail for security issues)
# 2. Code Quality & Testing (Parallel testing by component)
# 3. Advanced Security Analysis (Deep security scanning)
# 4. Deployment Security (Production deployment verification)
# 5. Security Monitoring (Daily scheduled security checks)
# 6. Agent Integration Testing (AI agent system validation)

# ğŸ”’ Security Features:
# - Secret detection with TruffleHog
# - API key leak prevention
# - Dependency vulnerability scanning
# - Code quality enforcement
# - Container security scanning
# - Environment protection
# - Automated security reporting